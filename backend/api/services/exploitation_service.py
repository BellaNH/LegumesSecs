from django.db.models import Q
from api.models import Exploitation, UserWilaya, UserSubdivision
from api.services.scoping_service import get_user_scope


def get_exploitations(user=None, filters=None, with_parcelles=False):
    """
    Get exploitations with optional filtering by location and user scope.
    
    Args:
        user: User instance for scope filtering
        filters: Dict with optional keys: wilaya_id, subdivision_id, commune_id
        with_parcelles: If True, prefetch related parcelles
    
    Returns:
        Filtered queryset
    """
    queryset = Exploitation.objects.select_related(
        'commune__subdivision__wilaya',
        'agriculteur'
    )
    
    if with_parcelles:
        queryset = queryset.prefetch_related('parcelles__espece')
    
    if filters:
        wilaya_id = filters.get('wilaya')
        subdivision_id = filters.get('subdivision')
        commune_id = filters.get('commune')
        
        if wilaya_id:
            try:
                wilaya_id = int(wilaya_id)
                if wilaya_id > 0:
                    queryset = queryset.filter(commune__subdivision__wilaya__id=wilaya_id)
            except (ValueError, TypeError):
                pass
        
        if subdivision_id:
            try:
                subdivision_id = int(subdivision_id)
                if subdivision_id > 0:
                    queryset = queryset.filter(commune__subdivision__id=subdivision_id)
            except (ValueError, TypeError):
                pass
        
        if commune_id:
            try:
                commune_id = int(commune_id)
                if commune_id > 0:
                    queryset = queryset.filter(commune__id=commune_id)
            except (ValueError, TypeError):
                pass
    
    if user:
        scope = get_user_scope(user)
        if not scope or scope.get("is_superuser"):
            return queryset
        
        role_nom = user.role.nom.lower() if user.role else None
        
        if role_nom == "agent_dsa":
            if scope.get("wilaya"):
                queryset = queryset.filter(
                    commune__subdivision__wilaya=scope["wilaya"]
                )
            else:
                return Exploitation.objects.none()
        elif role_nom == "agent_subdivision":
            if scope.get("subdivision"):
                queryset = queryset.filter(
                    commune__subdivision=scope["subdivision"]
                )
            else:
                return Exploitation.objects.none()
        else:
            return Exploitation.objects.none()
    
    return queryset

